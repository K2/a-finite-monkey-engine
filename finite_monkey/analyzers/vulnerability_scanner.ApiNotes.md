# Vulnerability Scanner API Notes

## Flow-Aware Vulnerability Scanning

The vulnerability scanner is designed to adapt its analysis based on the business flows identified in earlier phases of the pipeline. This makes the scanning more context-aware and focused on relevant security issues.

### Flow Context Integration

When analyzing a contract, the scanner:

1. Extracts business flow information from the context
2. Identifies flow types (token_transfer, access_control, etc.)
3. Tailors the LLM prompts based on these flow types
4. Focuses analysis on functions involved in these flows

Example of flow context extraction:

```python
flow_context = {
    'contract_name': {
        'flows': [
            {'name': 'Token Transfer', 'type': 'token_transfer', 'functions': ['transfer', 'transferFrom']}
        ],
        'flow_types': ['token_transfer'],
        'functions': ['transfer', 'transferFrom']
    }
}
```

This context is then used to generate more specific prompts for the LLM.

## Configuration Through nodes_config

All configuration parameters come from the central `nodes_config` module:

1. `REQUEST_TIMEOUT`: Maximum time allowed for a vulnerability scan (default: 900s)
2. `MAX_CONCURRENT_SCANS`: Limit on parallel scans (default: 3)
3. `SCAN_THROTTLE`: Time between scans to prevent resource exhaustion (default: 0.5s)
4. `VULNERABILITY_CATEGORIES`: Categories of vulnerabilities to scan for

Example configuration in nodes_config.py:
```python
# Vulnerability scanning parameters
REQUEST_TIMEOUT = 600.0  # 10 minutes
MAX_CONCURRENT_SCANS = 5
SCAN_THROTTLE = 0.2
VULNERABILITY_CATEGORIES = [
    "reentrancy", "access_control", "arithmetic", "front_running",
    "unchecked_return", "denial_of_service", "time_manipulation"
]
```

## Handling Different Response Formats

The scanner uses the `llm_interface` utility to handle different LLM implementations consistently, then processes the response in two ways:

1. **JSON Parsing**: Tries to extract structured JSON from the response
2. **Regex Fallback**: Falls back to regex pattern matching if JSON parsing fails

This dual approach ensures robust vulnerability extraction regardless of LLM response format.
